# =============================================================================
# News Digest - PRODUCTION Docker Compose Override
# =============================================================================
# This file contains production-specific overrides.
#
# Usage:
#   docker compose -f docker-compose.yml -f docker-compose.prod.yml up -d
#
# This overlay:
#   - Removes port exposures that should only be internal
#   - Adds production-specific healthcheck tuning
#   - Removes development-only services (pgadmin)
#   - Adds resource constraints
#   - Configures proper restart policies
# =============================================================================

services:
  # ---------------------------------------------------------------------------
  # Database - Production settings
  # ---------------------------------------------------------------------------
  db:
    # Remove external port exposure - only accessible within Docker network
    ports: !reset []
    # Add resource limits
    deploy:
      resources:
        limits:
          memory: 512M
        reservations:
          memory: 256M
    # Ensure proper restart
    restart: always

  # ---------------------------------------------------------------------------
  # API - Production settings
  # ---------------------------------------------------------------------------
  api:
    # Remove external port exposure - only accessible via nginx
    ports: !reset []
    # Production environment
    environment:
      - DATABASE_URL=postgresql+asyncpg://newsdigest:${POSTGRES_PASSWORD}@db:5432/newsdigest_db
      - APP_ENV=production
      - DEBUG=false
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
      - JWT_SECRET_KEY=${JWT_SECRET_KEY}
      - NEWSAPI_KEY=${NEWSAPI_KEY}
      - OPENAI_API_KEY=${OPENAI_API_KEY}
      - CORS_ORIGINS=${CORS_ORIGINS:-https://dailydigestbot.com}
      - SCHEDULER_ENABLED=${SCHEDULER_ENABLED:-true}
      - RATE_LIMIT_PER_MINUTE=${RATE_LIMIT_PER_MINUTE:-60}
      - RATE_LIMIT_BURST=${RATE_LIMIT_BURST:-10}
    # Resource limits
    deploy:
      resources:
        limits:
          memory: 1G
        reservations:
          memory: 512M
    restart: always

  # ---------------------------------------------------------------------------
  # Frontend - Production settings
  # ---------------------------------------------------------------------------
  frontend:
    # Resource limits
    deploy:
      resources:
        limits:
          memory: 256M
        reservations:
          memory: 128M
    restart: always

  # ---------------------------------------------------------------------------
  # Nginx - Production settings
  # ---------------------------------------------------------------------------
  nginx:
    # Expose only necessary ports
    ports:
      - "80:80"
      - "443:443"
    # Mount SSL certificates from Let's Encrypt
    volumes:
      - /etc/letsencrypt:/etc/letsencrypt:ro
      - /var/www/certbot:/var/www/certbot:ro
    deploy:
      resources:
        limits:
          memory: 128M
        reservations:
          memory: 64M
    restart: always

  # ---------------------------------------------------------------------------
  # pgAdmin - DISABLED in production
  # ---------------------------------------------------------------------------
  pgadmin:
    # Scale to 0 effectively disables the service
    deploy:
      replicas: 0
    # Or alternatively, use profiles (requires docker compose v2.1+)
    # profiles:
    #   - development
